<!DOCTYPE html>
<html>
  <head>
    <title>Read Text File Tutorial</title>
  </head>
  <body>
    <input type="file" name="inputFile" id="inputFile">  <!-- 파일을 업로드할 때 사용하는 HRML 태그 --> 
    <br>
    <pre id="output"></pre>
  
    <!-- 
      FileReader 사용 방법 
      1. new 연산자를 사용하여 FileReader 객체 생성 
      ex) var file = new FileREader();
      
      2. 객체 생성 후 아래의 네 가지 함수 중 하나를 호출하여 File 또는 Blob를 읽어서 result 속성에 저장한다. 
      네 가지 함수의 인수는 File 또는 Blob 객체
      - readAsText() : 파일 객체의 내용을 텍스트로 읽는다. 파일의 내용은 result 속성에는 문자열 값으로 들어간다.
      - readAsDataURL() : 파일 객체를 읽은 후 데이터 URL 표현으로 변환한다.
      - readAsArrayBuffer() : 파일 객체의 내용을 배열 버퍼로 읽는다.
      - readAsBinartString() : 파일 객체의 내용을 비트 문자열로 읽는다.
      ex) file.readAsText(File 또는 Blob)
    
      3. File 또는 Blob 객체를 읽은 결과를 처리한다.
      - load : 파일 읽기 작업이 완됴되면 작동
      - error : 에러로 인해 파일을 읽을 수 없을 때 동작
      - abort : abort() 함수를 호출하여  파일 읽기 작업이 취소될 때 동작
      - progress : 파일을 읽는 동안 일정한 간격으로 동작

      4. FileReader 객체의 주요 속성
      가장 핵심적인 속성 3가지
      - result : 파일 읽은 결과를 가지고 있거나 null 값을 가짐
      - error : 읽기 작업에서 발생한 오류를 설명하는 Error 객체를 가지거나 null 값을 가짐
      - readyState : 객체의 상태를 숫자로 관리. 
        0은 비어있음(Empty)으로 FileReader 객체에서 읽기 작업이 수행되지 않았음을 의미.
        1은 로딩 중(Loading)으로 파일을 읽는 중을 의미
        2는 파일 읽기 작업이 완료(Done) 되었음을 의미
    -->

    <script type="text/javascript">

      //document.getElementById("ID명") : id 이름이 inputFile인 것을 html 파일에서 가져오겠다.
      document.getElementById('inputFile').addEventListener('change', function() {  //change : 업로드 이벤트를 실행
     
        var file = new FileReader();
        
        file.onload = () => { //onload : 문서에 포함된 모든 콘텐츠가 로드된 후에 실행 : 파일이 모드 로드된 후 실행
          // document.getElementById('output').textContent = file.result.split("\n");  //id가 output인 html 태그에 읽은 파일의 결과 담기.
          var result = file.result; //파일 결과 result 변수에 담기
          var line = result.split("\n");  //개행문자로 분리
          //result의 길이만큼 반복         
          console.log(line.length); //1342개
          
          var size = line.length-2; //헤더 제외한 size 구하기
          
          console.log(size);  //size 개수 확인

          var x_plr = [size]; //1340개 (데이터 개수)만큼 배열 선언
          var x_delay = [size];
          var y_label = [size];
          var count = 0;  //반복문에 사용하기 위한 count 0으로 초기화
          
          for(var i=1; i<line.length-1; i++){
            for(var j=0; j<line[i].split(",").length; j++){
                //substring("시작위치", "길이")   
                //길이 부분을 생략할 경우 시작 위치부터 문자열 끝까지 자름
                //indexOf("찾을 문자열", "시작 위치")
                //찾을 문자열만 인자로 넣을 경우 찾은 문자열의 시작 위치를 반환. 찾을 문자열이 없을 경우 -1 반환
                //찾을 위치를 두 번째 인자에 부여하면 시작 위치부터 문자열을 찾음
                x_plr[count] = line[i].substring(0, line[i].indexOf(','));  
                x_delay[count] = line[i].substring(line[i].indexOf(',')+1, line[i].indexOf(',', line[i].indexOf(',') + 1));
                y_label[count] = line[i].substring(line[i].lastIndexOf(',')+1, line[i].lastIndexOf('\r'));
            }
            count++;
            //document.getElementById('output').textContent = line;
            // document.write(line[i]);  //줄별로 분리
          }          

          //count 개수 size와 일치한지 확인
          console.log(count);
          
          //배열에 값이 잘 담겼는지 확인
          for(var i=0; i<size; i++){
            document.write(x_plr[i] + '&nbsp;');
            document.write(x_delay[i] + '&nbsp;');
            document.write(y_label[i] + '&nbsp;');
            document.write('<br>');
          }

          //JSON으로 변환
          //JSON.stringfy() 메소드 : 자바 스크립트 값이나 객체를 JSON 문자열로 변환
         
          const data = {
            x_plr : x_plr,
            x_delay : x_delay,
            y_label : y_label,
          };


          const json = JSON.stringify(data, null, 2); //세 번째 인자 : 2개의 공백만큼 들여쓰기

          console.log(json);   
          // document.getElementById('output').textContent = result;
        
          // const response = fetch("url", {
          //   method: 'POST',
          //   headers: {
          //     'Content-Type' : 'application/json;charset=utf-8'
          //   },
          //   body : json
          // });
          
          // let result = await response.json();
          // alert(result.message);

        }
        file.readAsText(this.files[0]); //readAsText(FILE) : 파일 객체의 내용 텍스트로 읽는다.
      });

      var url = window.location.href; //현재 html 주소 확인
      console.log(url);

     
    </script>
  </body>
</html>
